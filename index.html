<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsChat - Chat en tiempo real</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',system-ui,sans-serif}body{background:linear-gradient(135deg,#0d1418 0%,#1a1a2e 100%);height:100vh;display:flex;justify-content:center;align-items:center;color:#e9edef}.app-container{display:flex;width:95%;max-width:1400px;height:95vh;background:#111b21;border-radius:12px;overflow:hidden;box-shadow:0 15px 35px rgba(0,0,0,.5)}.sidebar{width:30%;min-width:320px;background:#111b21;border-right:1px solid #2a3942;display:flex;flex-direction:column}.sidebar-header{padding:16px;background:#202c33;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #2a3942}.user-info{display:flex;align-items:center;gap:12px}.avatar{width:45px;height:45px;border-radius:50%;background:linear-gradient(135deg,#00a884,#25d366);display:flex;align-items:center;justify-content:center;font-size:18px;color:#fff;font-weight:bold}.user-details h3{font-size:16px;font-weight:500;margin-bottom:4px}.status{font-size:12px;color:#8696a0}.status.online{color:#25d366}.sidebar-actions{display:flex;gap:15px}.icon-btn{background:0 0;border:none;color:#aebac1;font-size:18px;cursor:pointer;padding:8px;border-radius:50%;transition:all .2s}.icon-btn:hover{background:#2a3942;color:#fff}.search-bar{padding:12px 16px;background:#111b21;border-bottom:1px solid #2a3942}.search-container{position:relative;display:flex;align-items:center}.search-container i{position:absolute;left:15px;color:#8696a0}.search-container input{width:100%;padding:10px 10px 10px 40px;background:#202c33;border:none;border-radius:8px;color:#e9edef;font-size:14px;outline:0}.contacts-list{flex:1;overflow-y:auto;padding:0}.contact-item{display:flex;align-items:center;padding:12px 16px;cursor:pointer;transition:background .2s;border-bottom:1px solid #222d34}.contact-item:hover{background:#202c33}.contact-avatar{width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;margin-right:12px;font-size:18px;color:#fff;font-weight:bold}.contact-info{flex:1}.contact-info h4{font-size:15px;font-weight:500;margin-bottom:4px}.contact-info p{font-size:13px;color:#8696a0}.contact-time{font-size:11px;color:#8696a0}.online-indicator{color:#25d366;font-size:10px}.chat-area{flex:1;display:flex;flex-direction:column;background:#0d1418}.chat-header{padding:12px 20px;background:#202c33;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #2a3942}.chat-partner-info{display:flex;align-items:center;gap:12px}.partner-avatar{width:45px;height:45px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;font-size:20px;color:#fff}.partner-details h2{font-size:17px;font-weight:500;margin-bottom:4px}#typing-indicator{font-size:13px;color:#25d366;height:18px}.messages-container{flex:1;padding:20px;overflow-y:auto;background:#0d1418;background-image:url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%232a3942' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E")}.message{max-width:65%;margin-bottom:12px;padding:10px 14px;border-radius:8px;animation:messageAppear .3s ease-out}@keyframes messageAppear{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}.message.received{background:#202c33;align-self:flex-start;border-top-left-radius:0}.message.sent{background:#005c4b;align-self:flex-end;border-top-right-radius:0}.message-header{display:flex;justify-content:space-between;margin-bottom:4px}.message-sender{font-weight:500;font-size:13px;color:#53bdeb}.message-time{font-size:11px;color:#8696a0}.message-content{font-size:14px;line-height:1.4}.system-message{text-align:center;margin:10px 0;font-size:13px;color:#8696a0;font-style:italic}.message-input-area{padding:12px 20px;background:#202c33;display:flex;align-items:center;gap:12px;border-top:1px solid #2a3942}.message-input-container{flex:1}#message-input{width:100%;padding:12px 18px;background:#2a3942;border:none;border-radius:25px;color:#e9edef;font-size:14px;outline:0}#message-input:focus{background:#36454f}.send-btn{width:45px;height:45px;border-radius:50%;background:linear-gradient(135deg,#00a884,#25d366);border:none;color:#fff;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}.send-btn:hover:not(:disabled){transform:scale(1.05)}.send-btn:disabled{background:#2a3942;color:#8696a0;cursor:not-allowed}.modal-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(11,20,26,.95);display:flex;align-items:center;justify-content:center;z-index:100}.modal-content{background:#202c33;border-radius:12px;width:90%;max-width:400px;padding:30px;text-align:center;box-shadow:0 20px 40px rgba(0,0,0,.4)}.modal-header{margin-bottom:25px}.modal-header h2{font-size:24px;color:#25d366;margin-bottom:10px}.modal-header p{color:#8696a0;font-size:14px}#username-input{width:100%;padding:14px;margin-bottom:20px;background:#2a3942;border:2px solid #36454f;border-radius:8px;color:#e9edef;font-size:16px;text-align:center;outline:0}#username-input:focus{border-color:#25d366}.btn-primary{width:100%;padding:14px;background:linear-gradient(135deg,#00a884,#25d366);border:none;border-radius:8px;color:#fff;font-size:16px;font-weight:500;cursor:pointer;transition:all .2s}.btn-primary:hover{transform:translateY(-2px)}::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:0 0}::-webkit-scrollbar-thumb{background:#2a3942;border-radius:3px}::-webkit-scrollbar-thumb:hover{background:#36454f}@media (max-width:768px){.app-container{width:100%;height:100vh;border-radius:0}.sidebar{min-width:100%}.message{max-width:85%}}
    </style>
</head>
<body>
    <div class="modal-overlay" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-comment-dots"></i> WhatsChat</h2>
                <p>Chat en tiempo real estilo WhatsApp</p>
            </div>
            <input type="text" id="username-input" placeholder="Tu nombre de usuario" maxlength="20" autocomplete="off" autofocus>
            <button class="btn-primary" id="join-chat-btn">
                <i class="fas fa-sign-in-alt"></i> Unirse al chat
            </button>
        </div>
    </div>

    <div class="app-container" id="appContainer" style="display:none">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="user-info">
                    <div class="avatar" id="user-avatar">U</div>
                    <div class="user-details">
                        <h3 id="username-display">Usuario</h3>
                        <span class="status" id="user-status">Desconectado</span>
                    </div>
                </div>
                <div class="sidebar-actions">
                    <button class="icon-btn" title="Estado"><i class="fas fa-circle"></i></button>
                    <button class="icon-btn" title="Nuevo chat"><i class="fas fa-comment-alt"></i></button>
                </div>
            </div>
            <div class="search-bar">
                <div class="search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Buscar contactos...">
                </div>
            </div>
            <div class="contacts-list" id="contacts-list">
                <div class="contact-item active">
                    <div class="contact-avatar"><i class="fas fa-users"></i></div>
                    <div class="contact-info">
                        <h4>WhatsChat General</h4>
                        <p>Grupo principal</p>
                    </div>
                    <div class="contact-time">
                        <span class="online-indicator"><i class="fas fa-circle"></i></span>
                    </div>
                </div>
            </div>
        </div>
        <div class="chat-area">
            <div class="chat-header">
                <div class="chat-partner-info">
                    <div class="partner-avatar"><i class="fas fa-users"></i></div>
                    <div class="partner-details">
                        <h2>WhatsChat General</h2>
                        <p id="typing-indicator"></p>
                    </div>
                </div>
                <div class="chat-actions">
                    <button class="icon-btn" title="Adjuntar"><i class="fas fa-paperclip"></i></button>
                </div>
            </div>
            <div class="messages-container" id="messages-container">
                <div style="text-align:center;padding:40px;color:#8696a0">
                    <h3>Bienvenido a WhatsChat</h3>
                    <p>Conéctate para comenzar a chatear</p>
                </div>
            </div>
            <div class="message-input-area">
                <div class="message-input-container">
                    <input type="text" id="message-input" placeholder="Escribe un mensaje..." disabled>
                </div>
                <button class="send-btn" id="send-button" disabled><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const socket = io();
            let username = '';
            
            // Elementos del DOM
            const loginModal = document.getElementById('loginModal');
            const appContainer = document.getElementById('appContainer');
            const usernameInput = document.getElementById('username-input');
            const joinBtn = document.getElementById('join-chat-btn');
            const usernameDisplay = document.getElementById('username-display');
            const userStatus = document.getElementById('user-status');
            const userAvatar = document.getElementById('user-avatar');
            const messageInput = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-button');
            const messagesContainer = document.getElementById('messages-container');
            const contactsList = document.getElementById('contacts-list');
            const typingIndicator = document.getElementById('typing-indicator');
            
            // Event Listeners
            joinBtn.addEventListener('click', joinChat);
            usernameInput.addEventListener('keypress', e => e.key === 'Enter' && joinChat());
            sendBtn.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', e => e.key === 'Enter' && sendMessage());
            
            // Socket events
            socket.on('connect', () => {
                console.log('✅ Conectado al servidor');
                if (username) userStatus.textContent = 'En línea';
            });
            
            socket.on('disconnect', () => {
                userStatus.textContent = 'Desconectado';
                userStatus.classList.remove('online');
            });
            
            socket.on('user_list_update', updateUserList);
            socket.on('new_message', addMessage);
            socket.on('message_history', loadMessages);
            socket.on('system_message', addSystemMessage);
            socket.on('user_typing', updateTyping);
            
            // Funciones
            function joinChat() {
                const name = usernameInput.value.trim();
                if (!name) {
                    alert('Por favor ingresa un nombre de usuario');
                    return;
                }
                
                username = name;
                usernameDisplay.textContent = name;
                userAvatar.textContent = name.charAt(0).toUpperCase();
                userStatus.textContent = 'En línea';
                userStatus.classList.add('online');
                
                // Mostrar app
                loginModal.style.display = 'none';
                appContainer.style.display = 'flex';
                
                // Habilitar chat
                messageInput.disabled = false;
                messageInput.placeholder = `Escribe un mensaje como ${name}...`;
                sendBtn.disabled = false;
                
                // Unirse al servidor
                socket.emit('user_join', name);
                showNotification('¡Bienvenido a WhatsChat!');
            }
            
            function sendMessage() {
                const text = messageInput.value.trim();
                if (!text) return;
                
                socket.emit('send_message', { username: username, text: text });
                messageInput.value = '';
                socket.emit('stop_typing', username);
            }
            
            function addMessage(message) {
                const isOwn = message.username === username;
                const time = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isOwn ? 'sent' : 'received'}`;
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <span class="message-sender">${message.username}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-content">${escapeHtml(message.text)}</div>
                `;
                
                messagesContainer.appendChild(messageDiv);
                scrollToBottom();
            }
            
            function addSystemMessage(data) {
                const time = new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const systemDiv = document.createElement('div');
                systemDiv.className = 'system-message';
                systemDiv.textContent = `${data.message} - ${time}`;
                messagesContainer.appendChild(systemDiv);
                scrollToBottom();
            }
            
            function loadMessages(messages) {
                messagesContainer.innerHTML = '';
                messages.forEach(msg => addMessage(msg));
                scrollToBottom();
            }
            
            function updateUserList(users) {
                contactsList.innerHTML = '';
                
                // Chat general
                const generalItem = document.createElement('div');
                generalItem.className = 'contact-item active';
                generalItem.innerHTML = `
                    <div class="contact-avatar"><i class="fas fa-users"></i></div>
                    <div class="contact-info">
                        <h4>WhatsChat General</h4>
                        <p>${users.filter(u => u.online).length} usuarios en línea</p>
                    </div>
                    <div class="contact-time">
                        <span class="online-indicator"><i class="fas fa-circle"></i></span>
                    </div>
                `;
                contactsList.appendChild(generalItem);
                
                // Usuarios
                users.forEach(user => {
                    if (user.username === username) return;
                    
                    const initials = user.username.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                    const lastSeen = user.online ? 'En línea' : 
                        `Últ. vez ${new Date(user.lastSeen).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
                    
                    const contactItem = document.createElement('div');
                    contactItem.className = 'contact-item';
                    contactItem.innerHTML = `
                        <div class="contact-avatar">${initials}</div>
                        <div class="contact-info">
                            <h4>${user.username}</h4>
                            <p>${lastSeen}</p>
                        </div>
                        <div class="contact-time">
                            ${user.online ? '<span class="online-indicator"><i class="fas fa-circle"></i></span>' : ''}
                        </div>
                    `;
                    contactsList.appendChild(contactItem);
                });
            }
            
            function updateTyping(users) {
                const otherUsers = users.filter(u => u !== username);
                if (otherUsers.length === 0) {
                    typingIndicator.textContent = '';
                } else if (otherUsers.length === 1) {
                    typingIndicator.textContent = `${otherUsers[0]} está escribiendo...`;
                } else {
                    typingIndicator.textContent = `${otherUsers.length} personas están escribiendo...`;
                }
            }
            
            function scrollToBottom() {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            function showNotification(message) {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position:fixed;bottom:20px;right:20px;background:#25d366;
                    color:#fff;padding:12px 20px;border-radius:8px;z-index:1000;
                    animation:slideIn .3s ease-out;
                `;
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
            
            // Detectar cuando el usuario está escribiendo
            let typingTimeout;
            messageInput.addEventListener('input', () => {
                if (username) {
                    socket.emit('typing', username);
                    clearTimeout(typingTimeout);
                    typingTimeout = setTimeout(() => {
                        socket.emit('stop_typing', username);
                    }, 1000);
                }
            });
        });
    </script>
</body>
</html>