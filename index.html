<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WhatsChat</title>

<style>
* {
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
  background: #0f172a;
  height: 100vh;
  display: flex;
  justify-content: center;
}

/* ===== CONTENEDOR ===== */
.app {
  width: 100%;
  max-width: 480px;
  background: #efeae2;
  display: flex;
  flex-direction: column;
  height: 100vh;
}

@media (min-width: 768px) {
  body {
    background: #111b21;
    align-items: center;
  }

  .app {
    height: 90vh;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0,0,0,.4);
  }
}

/* ===== HEADER ===== */
.header {
  background: #075e54;
  color: #fff;
  padding: 14px;
  font-weight: 600;
  font-size: 16px;
}

/* ===== MENSAJES ===== */
.messages {
  flex: 1;
  padding: 12px;
  overflow-y: auto;
  background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' xmlns='http://www.w3.org/2000/svg'%3E%3Crect fill='%23efeae2' width='100' height='100'/%3E%3Cpath d='M0 0h50v50H0zM50 50h50v50H50z' fill='%23e5ddd5'/%3E%3C/svg%3E");
}

/* ===== BURBUJAS ===== */
.message {
  max-width: 78%;
  padding: 8px 10px 18px;
  margin-bottom: 8px;
  font-size: 14px;
  line-height: 1.4;
  border-radius: 8px;
  box-shadow: 0 1px 1px rgba(0,0,0,.15);
  position: relative;
  word-wrap: break-word;
}

.message.me {
  background: #dcf8c6;
  margin-left: auto;
  border-bottom-right-radius: 0;
}

.message.other {
  background: #fff;
  margin-right: auto;
  border-bottom-left-radius: 0;
}

/* ===== TIMESTAMP ===== */
.time {
  position: absolute;
  bottom: 4px;
  right: 8px;
  font-size: 11px;
  color: #667781;
}

/* ===== INPUT ===== */
.input-bar {
  display: flex;
  padding: 10px;
  background: #f0f2f5;
  align-items: center;
}

.input-bar input {
  flex: 1;
  border: none;
  border-radius: 20px;
  padding: 10px 14px;
  font-size: 14px;
  outline: none;
}

.input-bar button {
  margin-left: 8px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  border: none;
  background: #075e54;
  color: #fff;
  font-size: 18px;
  cursor: pointer;
}

.input-bar button:hover {
  background: #0b7a66;
}
</style>
</head>

<body>

<div class="app">
  <div class="header">WhatsChat</div>

  <div id="mensajes" class="messages"></div>

  <div class="input-bar">
    <input id="input" placeholder="EscribÃ­ un mensajeâ€¦" autocomplete="off">
    <button id="btn">âž¤</button>
  </div>
</div>

<script>
  // WebSocket connection
  const protocol = location.protocol === "https:" ? "wss" : "ws";
  const ws = new WebSocket(`${protocol}://${location.host}`);
  
  // Elementos DOM
  const mensajesContainer = document.getElementById('mensajes');
  const input = document.getElementById('input');
  const btn = document.getElementById('btn');
  const statusText = document.getElementById('statusText');
  const userCount = document.getElementById('userCount');
  const connectionStatus = document.getElementById('connectionStatus');
  
  // Variables de estado
  let userName = `Usuario${Math.floor(Math.random() * 1000)}`;
  let userColor = generateColor();
  
  // Generar color Ãºnico para el usuario
  function generateColor() {
    const colors = [
      '#FF6B6B', '#4ECDC4', '#FFD166', '#06D6A0',
      '#118AB2', '#EF476F', '#073B4C', '#7209B7'
    ];
    return colors[Math.floor(Math.random() * colors.length)];
  }
  
  // Formatear hora actual
  function getCurrentTime() {
    const now = new Date();
    return now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
  }
  
  // Crear burbuja de mensaje
  function createMessageBubble(text, isSent = false) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
    
    const bubbleDiv = document.createElement('div');
    bubbleDiv.className = 'message-bubble';
    
    const textDiv = document.createElement('div');
    textDiv.className = 'message-text';
    textDiv.textContent = text;
    
    const timeDiv = document.createElement('div');
    timeDiv.className = 'message-time';
    timeDiv.textContent = getCurrentTime();
    
    // Si es mensaje recibido Y tiene formato "nombre: texto", separarlos
    if (!isSent && text.includes(': ')) {
      const userDiv = document.createElement('div');
      const parts = text.split(': ');
      const senderName = parts[0];
      const messageText = parts.slice(1).join(': ');
      
      userDiv.className = 'message-user';
      userDiv.textContent = senderName;
      userDiv.style.color = userColor;
      userDiv.style.fontSize = '12px';
      userDiv.style.fontWeight = 'bold';
      userDiv.style.marginBottom = '3px';
      bubbleDiv.insertBefore(userDiv, textDiv);
      
      // Mostrar solo el texto del mensaje (sin el nombre)
      textDiv.textContent = messageText;
    }
    
    bubbleDiv.appendChild(textDiv);
    bubbleDiv.appendChild(timeDiv);
    messageDiv.appendChild(bubbleDiv);
    
    return messageDiv;
  }
  
  // Eventos WebSocket
  ws.onopen = () => {
    console.log("âœ… WebSocket conectado");
    statusText.textContent = 'Conectado';
    connectionStatus.style.background = 'rgba(76, 175, 80, 0.9)';
    
    // Enviar mensaje de unirse (opcional, si quieres notificar a otros)
    // const joinMessage = `${userName} se ha unido al chat`;
    // ws.send(joinMessage);
    
    // Mostrar mensaje de bienvenida local
    const welcomeDiv = createMessageBubble('Â¡Bienvenido a WhatsChat! Los mensajes persisten hasta que el servidor se reinicie.', false);
    mensajesContainer.appendChild(welcomeDiv);
    mensajesContainer.scrollTop = mensajesContainer.scrollHeight;
  };
  
  ws.onerror = (e) => {
    console.error("âŒ WebSocket error", e);
    statusText.textContent = 'Error de conexiÃ³n';
    connectionStatus.style.background = 'rgba(244, 67, 54, 0.9)';
  };
  
  ws.onclose = () => {
    console.log("ðŸ”Œ WebSocket cerrado");
    statusText.textContent = 'Desconectado';
    connectionStatus.style.background = 'rgba(158, 158, 158, 0.9)';
  };
  
  // CORRECCIÃ“N CLAVE: Manejo de mensajes entrantes e historial
  ws.onmessage = async (event) => {
    const rawText = typeof event.data === "string" ? event.data : await event.data.text();
    
    // Determinar si el mensaje es propio
    const isOwnMessage = rawText.startsWith(`${userName}: `);
    
    // Mostrar TODOS los mensajes, excepto la notificaciÃ³n de uniÃ³n propia
    if (rawText === `${userName} se ha unido al chat`) {
      return; // No mostrar nuestra propia notificaciÃ³n de uniÃ³n
    }
    
    const messageDiv = createMessageBubble(rawText, isOwnMessage);
    mensajesContainer.appendChild(messageDiv);
    mensajesContainer.scrollTop = mensajesContainer.scrollHeight;
  };
  
  // Enviar mensaje
  function sendMessage() {
    const texto = input.value.trim();
    if (texto !== "") {
      // Crear mensaje con nombre de usuario
      const fullMessage = `${userName}: ${texto}`;
      
      // Mostrar mensaje propio inmediatamente (feedback local)
      const messageDiv = createMessageBubble(fullMessage, true);
      mensajesContainer.appendChild(messageDiv);
      mensajesContainer.scrollTop = mensajesContainer.scrollHeight;
      
      // Enviar al servidor para almacenamiento y broadcast
      ws.send(fullMessage);
      input.value = "";
      input.focus();
    }
  }
  
  // Event listeners
  btn.onclick = sendMessage;
  input.onkeypress = (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      sendMessage();
      e.preventDefault();
    }
  };
  
  // Cargar nombre de usuario
  window.addEventListener('DOMContentLoaded', () => {
    const savedName = localStorage.getItem('chatUsername');
    if (savedName) {
      userName = savedName;
    } else {
      localStorage.setItem('chatUsername', userName);
    }
    userCount.textContent = "1 usuario conectado";
  });
  
  // Scroll al final al cargar
  window.addEventListener('load', () => {
    setTimeout(() => {
      mensajesContainer.scrollTop = mensajesContainer.scrollHeight;
    }, 300);
  });
</script>

</body>
</html>